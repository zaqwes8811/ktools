FROM ubuntu:22.04

RUN apt-get update && apt-get install -y gcc g++ gperf bison flex texinfo help2man make libncurses5-dev \
    python3-dev autoconf automake libtool libtool-bin gawk wget bzip2 xz-utils unzip \
    patch libstdc++6 rsync git meson ninja-build dos2unix \
    libmpc-dev libgmp3-dev \
    bc \
    python3-venv python3-pip \
    pkg-config libglib2.0-dev libpixman-1-dev \
    cpio && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean

RUN pip3 install tomli

# From source code

WORKDIR /opt/

ENV QEMU_VERSION=9.2.4
ENV NG_TAG=tags/crosstool-ng-1.27.0
ENV NG_BIN=/opt/crosstool-ng-root/

RUN chmod -R 777 /opt/

# Need for build toolchain
RUN useradd -m builder
ENV HOME=/home/builder

USER builder

RUN mkdir ~/src && cd ~/src/ && wget https://zlib.net/fossils/zlib-1.2.12.tar.gz

RUN git clone https://github.com/crosstool-ng/crosstool-ng.git \
    && cd crosstool-ng && git checkout $NG_TAG -b ct-ng \
    && find . -type f -exec dos2unix {} \; \
    && ./bootstrap && ./configure --prefix=$NG_BIN \
    && make install \
    && $NG_BIN/bin/ct-ng aarch64-unknown-linux-gnu \
    && CT_PARALLEL_JOBS=2 $NG_BIN/bin/ct-ng build \
    && cd .. && rm -rf crosstool-ng

USER root

# Qemu
WORKDIR /opt/
RUN mkdir tools && cd tools \
    && wget https://download.qemu.org/qemu-$QEMU_VERSION.tar.xz \
    && tar xvJf qemu-$QEMU_VERSION.tar.xz && rm qemu-$QEMU_VERSION.tar.xz

RUN cd tools/qemu-$QEMU_VERSION && ./configure --target-list="aarch64-softmmu" --enable-virtfs \
    && make

ENV PATH="$PATH:$NG_BIN/bin"
ENV PATH="$PATH:/opt/tools/qemu-$QEMU_VERSION/build/qemu-bundle/usr/local/bin"
ENV PATH="$PATH:$HOME/x-tools/aarch64-unknown-linux-gnu/bin"

ENV ARCH=arm64
ENV CROSS_COMPILE=aarch64-unknown-linux-gnu-

ENV KERNEL_MAJOR=6
ENV KERNEL_VERSION=$KERNEL_MAJOR.1.68

RUN wget https://cdn.kernel.org/pub/linux/kernel/v$KERNEL_MAJOR.x/linux-$KERNEL_VERSION.tar.xz

COPY fragment_tc_off.config .

# Rootfs

WORKDIR $HOME
