FROM ubuntu:22.04

ENV QEMU_VERSION=9.2.4
ENV NG_TAG=tags/crosstool-ng-1.27.0
ENV NG_BIN=/opt/crosstool-ng-root/
ENV ARCH=arm64
ENV CROSS_COMPILE=aarch64-unknown-linux-gnu-

# Used stock kernel
ENV KERNEL_MAJOR=6
ENV KERNEL_VERSION=$KERNEL_MAJOR.1.68
ENV ROOTFS_ROOT=/opt/busybox/_install/
ENV BUSYBOX_TAG=tags/1_36_0

RUN apt-get update && apt-get install -y gcc g++ gperf bison flex texinfo help2man make libncurses5-dev \
    python3-dev autoconf automake libtool libtool-bin gawk wget bzip2 xz-utils unzip \
    patch libstdc++6 rsync git meson ninja-build dos2unix \
    libmpc-dev libgmp3-dev \
    bc \
    python3-venv python3-pip \
    pkg-config libglib2.0-dev libpixman-1-dev \
    cpio \
    device-tree-compiler libssl-dev && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean

RUN pip3 install tomli

# From source code
WORKDIR /opt/

RUN chmod -R 777 /opt/

# Need for build toolchain
RUN useradd -m builder
ENV HOME=/home/builder

USER builder

RUN mkdir ~/src && cd ~/src/ \
    && wget https://zlib.net/fossils/zlib-1.2.12.tar.gz \
    && wget https://sourceforge.net/projects/libisl/files/isl-0.26.tar.xz/download -O isl-0.26.tar.xz

RUN git clone https://github.com/crosstool-ng/crosstool-ng.git \
    && cd crosstool-ng && git checkout $NG_TAG -b ct-ng \
    && find . -type f -exec dos2unix {} \; \
    && ./bootstrap && ./configure --prefix=$NG_BIN \
    && make install \
    && $NG_BIN/bin/ct-ng aarch64-unknown-linux-gnu

RUN cd crosstool-ng && $NG_BIN/bin/ct-ng source

RUN cd crosstool-ng && CT_PARALLEL_JOBS=2 $NG_BIN/bin/ct-ng build \
    && cd .. && rm -rf crosstool-ng

USER root

# Qemu
WORKDIR /opt/
RUN mkdir tools && cd tools \
    && wget https://download.qemu.org/qemu-$QEMU_VERSION.tar.xz \
    && tar xvJf qemu-$QEMU_VERSION.tar.xz && rm qemu-$QEMU_VERSION.tar.xz

RUN cd tools/qemu-$QEMU_VERSION && ./configure --target-list="aarch64-softmmu" --enable-virtfs \
    && make

ENV PATH="$PATH:$NG_BIN/bin"
ENV PATH="$PATH:/opt/tools/qemu-$QEMU_VERSION/build/qemu-bundle/usr/local/bin"
ENV PATH="$PATH:$HOME/x-tools/aarch64-unknown-linux-gnu/bin"

RUN wget https://cdn.kernel.org/pub/linux/kernel/v$KERNEL_MAJOR.x/linux-$KERNEL_VERSION.tar.xz

# Rootfs
USER builder
RUN git clone git://busybox.net/busybox.git && cd busybox && git checkout $BUSYBOX_TAG -b bb \
    && make defconfig \
    && tar -xvf /opt/linux-$KERNEL_VERSION.tar.xz -C /tmp/ \
    && /tmp/linux-$KERNEL_VERSION/scripts/config --disable CONFIG_TC \
    && /tmp/linux-$KERNEL_VERSION/scripts/config --enable CONFIG_FEATURE_MOUNT_FSTAB \
    && /tmp/linux-$KERNEL_VERSION/scripts/config --enable CONFIG_BINFMT_SCRIPT \
    && make && make install \
    && rm -rf /tmp/linux-$KERNEL_VERSION

# Full rootfs with files and folders
RUN cd $ROOTFS_ROOT && mkdir -p bin dev etc home lib lib64 proc sbin sys tmp usr var \
    && mkdir -p usr/bin usr/lib usr/sbin var/log \
    && export SYSROOT=$(aarch64-unknown-linux-gnu-gcc -print-sysroot) \
    && cp $SYSROOT/lib/ld-linux-aarch64.so.1 lib64 \
    && cp $SYSROOT/lib/ld-linux-aarch64.so.1 lib \
    && cp $SYSROOT/lib/libm.so.6 lib64 \
    && cp $SYSROOT/lib/libresolv.so.2 lib64 \
    && cp $SYSROOT/lib/libc.so.6 lib64 \
    && cp $SYSROOT/lib/libstdc++.so.6 lib64 \
    && cp $SYSROOT/lib/libgcc_s.so.1 lib64

RUN echo '#!/bin/sh\n\
# devtmpfs does not get automounted for initramfs\n\
/bin/mount -t devtmpfs devtmpfs /dev\n\
exec 0</dev/console\n\
exec 1>/dev/console\n\
exec 2>/dev/console\n\
exec /sbin/init $*\n\
' > $ROOTFS_ROOT/init

RUN cp /opt/busybox/examples/inittab $ROOTFS_ROOT/etc/
RUN mkdir -p $ROOTFS_ROOT/etc/init.d/

RUN echo '#!/bin/sh\n\
mount -t proc proc /proc\n\
mount -t sysfs sysfs /sys\n\
mount -t debugfs none /sys/kernel/debug/\n\
mkdir -p /workdir\n\
mount -t 9p -o trans=virtio,version=9p2000.L host0 /workdir\n\
ln -s /workdir/Android-kernel/bore-modules/drivers/soc/bore/alure /alure\n\
' > $ROOTFS_ROOT/etc/init.d/rcS

RUN chmod +x $ROOTFS_ROOT/init && chmod +x $ROOTFS_ROOT/etc/init.d/rcS

USER root

RUN ln -s $ROOTFS_ROOT /rootfs

# DTB
ENV QEMU_AARCH64_CALL_PREFIX="qemu-system-aarch64 -machine virt,gic_version=3 -cpu cortex-a72 -machine type=virt -smp 4 -m 1024"

RUN $QEMU_AARCH64_CALL_PREFIX -display none -machine dumpdtb=virt-gicv3.dtb \
    && dtc -I dtb -O dts  -f virt-gicv3.dtb -o virt-gicv3.dtsi

RUN apt-get update && apt-get install -y nano && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean

ENV KERNEL_SRC=$HOME/workdir/linux-$KERNEL_VERSION
ENV ROOTFS_MODULES_DIR=$ROOTFS_ROOT/lib/modules/$KERNEL_VERSION

USER builder
RUN mkdir -p $ROOTFS_MODULES_DIR
USER root

COPY env.sh /

RUN apt-get update && apt-get install -y cmake && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean

WORKDIR $HOME
